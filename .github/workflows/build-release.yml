name: Sync & Build x86-64-v3

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  sync-build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Install tools
        run: |
          pacman -Syyu --noconfirm
          pacman -S --noconfirm archlinux-keyring base-devel git curl go jq

      # -------------------------
      # Get latest upstream release
      # -------------------------
      - name: Fetch upstream release
        id: upstream
        run: |
          LATEST=$(curl -s https://api.github.com/repos/AvengeMedia/DankMaterialShell/releases/latest | jq -r .tag_name)
          VERSION=${LATEST#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$LATEST" >> $GITHUB_OUTPUT

      # -------------------------
      # Check if already built
      # -------------------------
      - name: Check existing release
        id: check
        run: |
          if curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.upstream.outputs.tag }} | grep -q tag_name; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # -------------------------
      # Stop if already exists
      # -------------------------
      - name: Stop if exists
        if: steps.check.outputs.exists == 'true'
        run: |
          echo "Release already exists. Skipping."
          exit 0

      # -------------------------
      # Create builder
      # -------------------------
      - name: Create builder
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      # -------------------------
      # Create PKGBUILD
      # -------------------------
      - name: Create PKGBUILD
        run: |
          cat > /home/builder/PKGBUILD << EOF
          pkgname=dms-shell
          pkgver=${{ steps.upstream.outputs.version }}
          pkgrel=1
          pkgdesc="Dank Material Shell (x86-64-v3 optimized)"
          arch=(x86_64)
          url="https://github.com/AvengeMedia/DankMaterialShell"
          license=(GPL-3.0-or-later)

          depends=(quickshell)
          makedepends=(go make)

          source=("\$url/archive/refs/tags/v\$pkgver.tar.gz")
          sha256sums=('SKIP')

          build() {
            cd DankMaterialShell-\$pkgver/core
            export GOAMD64=v3
            export CGO_ENABLED=1
            make
          }

          package() {
            cd DankMaterialShell-\$pkgver
            install -Dm755 core/bin/dms "\$pkgdir/usr/bin/dms"
            mkdir -p "\$pkgdir/usr/share/quickshell/dms"
            cp -r quickshell/* "\$pkgdir/usr/share/quickshell/dms/"
          }
          EOF

          chown -R builder:builder /home/builder

      # -------------------------
      # Build
      # -------------------------
      - name: Build package
        run: |
          su builder -c "cd ~ && makepkg -s --noconfirm"

      # -------------------------
      # Rename
      # -------------------------
      - name: Prepare artifact
        run: |
          PKG_PATH=$(find /home/builder -name "*.pkg.tar.zst" | head -n1)
          VERSION=${{ steps.upstream.outputs.version }}
          mkdir release
          cp "$PKG_PATH" "release/dms-shell-${VERSION}-x86_64_v3.pkg.tar.zst"

      # -------------------------
      # Create release
      # -------------------------
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.upstream.outputs.tag }}
          name: dms-shell ${{ steps.upstream.outputs.version }} (x86-64-v3)
          files: release/*.pkg.tar.zst
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
